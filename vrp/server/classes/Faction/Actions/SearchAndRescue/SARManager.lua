-- ****************************************************************************
-- *
-- *  PROJECT:     vRoleplay
-- *  FILE:        server/classes/Faction/Actions/SearchAndRescue/SARManager.lua
-- *  PURPOSE:     Search and Rescue Manager Class
-- *
-- ****************************************************************************

SARManager = inherit(Singleton)

local SAR_TIME_MIN = 240 -- in minutes
local SAR_TIME_MAX = 360 -- in minutes
local SAR_MIN_PLAYERS = 2
local SAR_MAX_CONCURRENT = 1

function SARManager:constructor()
    self.m_CurrentSAR = { }
    self.m_SARMissions = {
        -- [0] = {"Name", "Description", blipX, blipY, minutes}
        [1] = {"Mount Chiliad", "Eine Gruppe Wanderer wird im Gebiet des Mount Chiliad vermisst.", -2371.401, -1611.086, 30},
        [2] = {"Einkaufszentrum LS", "Ein Amokläufer hat mehrere Besucher eines Einkaufszentrums beim All Saints General Hospital verletzt.", 1129.113, -1489.698, 5},
        [3] = {"Geisterstadt", "Einige Jugendliche sind von einer Übernachtung in der sogenannten Geisterstadt nicht zurückgekehrt.", -384.62, 2239.91, 15},
        [4] = {"Schiffsunglück", "Opfer eines Schiffsunglücks wurden an den Strand nahe Angel Pine gespült.", -2644.75, -2699.29, 20},
        [5] = {"Baustelle", "Mehrere Personen wurden auf einer Baustelle in San Fierro verletzt.", -2077.28, 210.26, 15},
        [6] = {"Flughafen SF", "Intensivpatienten sind aus dem Krankenhaus geflohen und haben sich auf dem Flughafen in San Fierro versteckt.", -1484.24, -371.95, 25},
        [7] = {"Pilzwald", "Wanderer haben in einem Waldstück nahe Los Santos giftige psychedelische Pilze gegessen und sich dann verirrt.", -765.67, -1957.65, 15},
        [8] = {"Waldstück", "Eine Fernsehteam ist gestern Nacht auf der Suche nach einem paranormalen Wesen im Wald verschwunden.", 2455.09, -666.58, 10},
        [9] = {"Ölfeld", "Arbeiter auf einem Ölfeld haben einen Hitzeschlag erlitten und sind umgekippt.", 563.75, 1368.96, 15},
        -- [10] = {"Las Barrancas", "TODO", -792.27, 1522.06, 0},
        -- [11] = {"Arco del Oeste", "TODO", -789.55, 2425.74, 0},
        -- [12] = {"Tierra Robada", "TODO", -1237.68, 2334.64, 0},
        -- [13] = {"Schrottplatz", "TODO", -1879.67, -1660.22, 0},
        -- [14] = {"The Farm", "TODO", -1105.77, -1022.68, 0},
        -- [15] = {"Golfplatz", "TODO", 1301.92, 2782.60, 0},
        -- [16] = {"Rockshore West", "TODO", 2288.87, 670.48, 0},
        -- [17] = {"Hampton Barns", "TODO", 753.64, 318.97, 0},
        -- [18] = {"Fern Ridge", "TODO", 867.41, 1.16, 0},
        -- [19] = {"Las Payasadas", "TODO", -233.30, 2697.79, 0},
        -- [20] = {"Flint Range", "TODO", -382.70, -1423.56, 0},
        -- [21] = {"Kiesgrube", "TODO", 609.08, 875.09, 0},
        -- [22] = {"Missionary Hill", "TODO", -2510.68, -616.73, 0},
        -- [23] = {"Flint County", "TODO", -34.45, -2720.99, 0},
    }
    self.m_MissionPeds = {
        --[[
        [0] = {
            [1] = {posX, posY, posZ},
            [2] = {posX, posY, posZ},
            [3] = {posX, posY, posZ},
            [4] = {posX, posY, posZ},
            [5] = {posX, posY, posZ},
            [6] = {posX, posY, posZ},
            [7] = {posX, posY, posZ},
            [8] = {posX, posY, posZ},
            [9] = {posX, posY, posZ},
            [10] = {posX, posY, posZ},
            [11] = {posX, posY, posZ},
            [12] = {posX, posY, posZ},
            [13] = {posX, posY, posZ},
            [14] = {posX, posY, posZ},
            [15] = {posX, posY, posZ},
        },
        ]]
        [1] = {
            [1] = {-2719.30, -1319.13, 150.31},
            [2] = {-2722.60, -1838.54, 149.90},
            [3] = {-2487.15, -1114.97, 137.41},
            [4] = {-2641.16, -1402.86, 264.53},
            [5] = {-2608.78, -1342.57, 260.49},
            [6] = {-2465.76, -1347.47, 310.96},
            [7] = {-2432.27, -1333.85, 310.63},
            [8] = {-2515.25, -1429.03, 349.52},
            [9] = {-2605.03, -1587.13, 344.27},
            [10] = {-2505.00, -1881.58, 300.06},
            [11] = {-2688.98, -1679.47, 257.37},
            [12] = {-1968.93, -1610.57, 87.01},
            [13] = {-1969.70, -1511.46, 88.32},
            [14] = {-2055.26, -1525.29, 125.16},
            [15] = {-2053.52, -1571.85, 139.35},
            [16] = {-2149.59, -1756.62, 210.28},
            [17] = {-2295.78, -1928.07, 273.47},
            [18] = {-2503.74, -1882.26, 299.87},
            [19] = {-2717.17, -1593.94, 236.61},
            [20] = {-2669.45, -1544.86, 305.26},
            [21] = {-2475.74, -1294.20, 297.37},
            [22] = {-2329.90, -1196.06, 205.74},
            [23] = {-2445.75, -1224.96, 232.65},
            [24] = {-2316.66, -1254.79, 244.20},
            [25] = {-2226.67, -1364.44, 278.14},
            [26] = {-2178.28, -1433.02, 220.12},
            [27] = {-2358.24, -1359.94, 299.41},
            [28] = {-2335.04, -1686.58, 484.58},
            [29] = {-2429.94, -1618.45, 525.47},
            [30] = {-2292.57, -1804.90, 438.10},
        },
        [2] = {
            [1] = {1145.928, -1449.324, 15.797},
            [2] = {1072.574, -1494.065, 22.756},
            [3] = {1118.865, -1514.919, 15.797},
            [4] = {1158.60, -1452.69, 22.77},
            [5] = {1144.86, -1426.53, 22.77},
            [6] = {1114.40, -1517.22, 15.80},
            [7] = {1097.45, -1481.94, 15.80},
            [8] = {1106.50, -1420.21, 15.80},
            [9] = {1138.93, -1483.36, 15.80},
            [10] = {1156.01, -1516.22, 22.75},
        },
        [3] = {
            [1] = {-480.40, 2183.54, 41.86},
            [2] = {-337.43, 2224.80, 42.49},
            [3] = {-333.21, 2215.00, 42.48},
            [4] = {-424.27, 2238.60, 42.43},
            [5] = {-403.49, 2267.75, 41.89},
            [6] = {-128.88, 2256.27, 27.88},
            [7] = {-423.12, 2125.82, 46.18},
            [8] = {-460.42, 2183.78, 47.05},
            [9] = {-503.15, 2287.86, 64.19},
            [10] = {-294.14, 2114.70, 51.23},
            [11] = {-296.04, 2066.68, 60.83},
            [12] = {-304.03, 2094.70, 35.48},
            [13] = {-323.40, 2277.85, 69.95},
            [14] = {-346.55, 2322.24, 58.42},
            [15] = {-516.75, 2132.25, 72.28},
        },
        [4] = {
            [1] = {-2651.61, -2196.68, 2.58},
            [2] = {-2656.03, -2262.75, 5.89},
            [3] = {-2691.85, -2222.15, 1.92},
            [4] = {-2765.13, -2289.94, 4.75},
            [5] = {-2701.47, -2328.40, 5.63},
            [6] = {-2825.21, -2392.42, 1.63},
            [7] = {-2793.37, -2418.74, 4.00},
            [8] = {-2712.86, -2468.84, 2.88},
            [9] = {-2604.40, -2524.65, 3.00},
            [10] = {-2753.56, -2607.04, 2.97},
            [11] = {-2669.10, -2629.50, 7.60},
            [12] = {-2596.65, -2657.94, 8.98},
            [13] = {-2661.96, -2692.41, 25.20},
            [14] = {-2682.34, -2746.38, 4.25},
            [15] = {-2588.69, -2718.99, 4.55},
            [16] = {-2515.30, -2757.13, 8.84},
            [17] = {-2482.69, -2847.05, 3.00},
            [18] = {-2408.50, -2768.31, 3.32},
            [19] = {-2338.46, -2804.86, 9.74},
            [20] = {-2250.03, -2824.05, 2.85},
            [21] = {-2176.55, -2815.32, 3.29},
            [22] = {-2102.02, -2826.16, 3.19},
            [23] = {-2013.36, -2781.55, 6.82},
            [24] = {-1978.65, -2814.99, 3.57},
            [25] = {-1925.39, -2762.62, 8.89},
            [26] = {-1841.85, -2742.58, 4.50},
            [27] = {-2660.21, -2479.70, 9.92},
            [28] = {-2798.44, -2481.81, 6.53},
            [29] = {-2596.87, -2749.97, 3.00},
            [30] = {-2611.85, -2859.42, 1.28},
        },
        [5] = {
            [1] = {-2132.53, 167.25, 42.25},
            [2] = {-2129.89, 151.18, 41.40},
            [3] = {-2134.77, 185.52, 42.25},
            [4] = {-2133.83, 173.77, 42.25},
            [5] = {-2134.11, 195.50, 35.29},
            [6] = {-2105.91, 139.20, 35.06},
            [7] = {-2059.31, 164.11, 28.84},
            [8] = {-2057.88, 229.84, 35.62},
            [9] = {-2060.49, 251.37, 34.94},
            [10] = {-2043.37, 307.54, 35.20},
            [11] = {-2052.43, 307.37, 41.99},
            [12] = {-2064.57, 307.51, 41.99},
            [13] = {-2069.78, 307.23, 41.99},
            [14] = {-2086.35, 303.25, 41.14},
            [15] = {-2134.30, 261.23, 35.62},
            [16] = {-2134.12, 262.37, 38.98},
            [17] = {-2125.09, 220.44, 35.36},
            [18] = {-2133.46, 238.25, 35.57},
            [19] = {-2119.90, 221.46, 38.81},
            [20] = {-2118.16, 221.90, 35.10},
        },
        [6] = {
            [1] = {-1253.07, 47.72, 14.14},
            [2] = {-1271.50, 48.05, 14.15},
            [3] = {-1120.09, -139.87, 14.14},
            [4] = {-1332.94, -501.71, 14.17},
            [5] = {-1501.42, -661.61, 14.14},
            [6] = {-1543.34, -692.28, 14.15},
            [7] = {-1701.62, -623.37, 14.15},
            [8] = {-1570.20, -553.24, 14.15},
            [9] = {-1410.31, -541.00, 14.17},
            [10] = {-1728.79, -367.74, 14.14},
            [11] = {-1024.95, 453.91, 14.55},
            [12] = {-1223.73, 280.26, 14.15},
            [13] = {-1383.29, 43.13, 14.54},
            [14] = {-1567.74, -90.35, 14.15},
            [15] = {-1565.05, -223.50, 14.14},
            [16] = {-1617.76, -466.79, 22.43},
            [17] = {-1371.00, -641.11, 14.15},
            [18] = {-1240.63, -540.18, 14.15},
            [19] = {-1329.58, -337.73, 14.15},
            [20] = {-1292.42, -177.67, 14.15},
            [21] = {-1207.74, -97.30, 14.14},
            [22] = {-1082.29, -216.91, 14.14},
            [23] = {-1189.34, 179.75, 14.15},
            [24] = {-1324.84, -690.09, 14.15},
            [25] = {-1369.04, -249.43, 14.14},
        },
        [7] = {
            [1] = {-707.09, -1897.87, 9.80},
            [2] = {-814.89, -1947.97, 9.71},
            [3] = {-748.92, -2054.76, 11.44},
            [4] = {-940.28, -1951.32, 45.61},
            [5] = {-752.81, -1848.10, 13.15},
            [6] = {-566.45, -1825.73, 30.90},
            [7] = {-548.52, -1969.61, 50.06},
            [8] = {-521.78, -1955.81, 39.43},
            [9] = {-644.19, -2114.63, 28.72},
            [10] = {-683.37, -2163.32, 23.36},
            [11] = {-732.13, -2196.20, 35.59},
            [12] = {-669.05, -1891.03, 6.18},
            [13] = {-542.80, -1903.01, 7.10},
            [14] = {-468.78, -1901.54, 7.49},
            [15] = {-777.17, -2209.03, 19.90},
        },
        [8] = {
            [1] = {2351.57, -648.61, 128.05},
            [2] = {2297.50, -609.07, 132.37},
            [3] = {2514.36, -722.14, 100.82},
            [4] = {2440.52, -655.07, 122.47},
            [5] = {2338.39, -746.70, 131.49},
            [6] = {2218.63, -613.00, 122.59},
            [7] = {2152.56, -560.03, 128.93},
            [8] = {2239.27, -574.42, 127.69},
            [9] = {2280.73, -496.52, 131.60},
            [10] = {2324.86, -551.54, 125.30},
            [11] = {2412.18, -538.89, 103.37},
            [12] = {2505.65, -418.26, 76.60},
            [13] = {2603.16, -500.45, 80.05},
            [14] = {2666.50, -546.94, 74.86},
            [15] = {2684.46, -621.17, 83.12},
        },
        [9] = {
            [1] = {611.17, 1556.49, 4.91},
            [2] = {597.32, 1493.12, 9.06},
            [3] = {555.96, 1493.68, 1.65},
            [4] = {492.58, 1531.42, 1.00},
            [5] = {421.70, 1520.70, 11.49},
            [6] = {402.33, 1465.43, 8.19},
            [7] = {453.27, 1423.81, 5.43},
            [8] = {507.34, 1393.42, 4.60},
            [9] = {562.71, 1381.84, 13.43},
            [10] = {562.29, 1311.75, 11.27},
            [11] = {491.00, 1309.85, 10.07},
            [12] = {429.50, 1265.73, 9.59},
            [13] = {348.98, 1316.81, 12.48},
            [14] = {645.96, 1482.38, 9.27},
            [15] = {622.17, 1318.07, 10.74},
            [16] = {477.53, 1436.61, 4.17},
            [17] = {704.35, 1402.20, 17.04},
            [18] = {629.66, 1325.20, 11.22},
            [19] = {562.97, 1368.26, 16.53},
            [20] = {440.53, 1534.11, 10.71},
        },
    }

    self.m_SARTimer = setTimer(bind(self.checkSAR, self), 1000 * 60 * math.random(SAR_TIME_MIN, SAR_TIME_MAX), 1)
end

function SARManager:checkSAR()
    if FactionRescue:getSingleton():countPlayers(true, false) >= SAR_MIN_PLAYERS and table.size(self.m_CurrentSAR) < SAR_MAX_CONCURRENT then
        self:startSAR()
    else
        outputDebug("Could not start SAR because not enough players or max concurrent already running")
    end

    if self.m_SARTimer:isValid() then self.m_SARTimer:destroy() end
    self.m_SARTimer = setTimer(bind(self.checkSAR, self), 1000 * 60 * math.random(SAR_TIME_MIN, SAR_TIME_MAX), 1)
end

function SARManager:startSAR(missionID)
    local missionID = tonumber(missionID)

    if not missionID then
        missionID = math.random(table.size(self.m_SARMissions))
    end

    self:stopSAR(missionID)

    outputDebug("Starting SAR with name " .. self.m_SARMissions[missionID][1])
    
    self.m_CurrentSAR[missionID] = SAR:new(self.m_MissionPeds[missionID], missionID, self.m_SARMissions[missionID])
end

function SARManager:stopSAR(missionID)
    local missionID = tonumber(missionID)

    if missionID then
        if self.m_CurrentSAR[missionID] then
            outputDebug("Stopping SAR with name " .. self.m_SARMissions[missionID][1])
            self.m_CurrentSAR[missionID]:delete()
            self.m_CurrentSAR[missionID] = nil
        end
    else
        for key, value in pairs(self.m_CurrentSAR) do
            outputDebug("Stopping SAR with name " .. self.m_SARMissions[key][1])
            self.m_CurrentSAR[key]:delete()
            self.m_CurrentSAR[key] = nil
        end
    end
end